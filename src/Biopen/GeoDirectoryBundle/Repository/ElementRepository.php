<?php

/**
 * This file is part of the MonVoisinFaitDuBio project.
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * @copyright Copyright (c) 2016 Sebastian Castro - 90scastro@gmail.com
 * @license    MIT License
 * @Last Modified time: 2017-05-04 17:48:58
 */
 

namespace Biopen\GeoDirectoryBundle\Repository;
use Doctrine\ODM\MongoDB\DocumentRepository;

/**
 * ElementRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ElementRepository extends DocumentRepository
{
  public function findAll()
  {
    $qb = $this->createQueryBuilder('BiopenGeoDirectoryBundle:Element');
    return $qb->select('compactJson')->hydrate(false)->getQuery()->execute()->toArray(); 
  }

  public function findAround($lat, $lng, $distance)
  {
    $qb = $this->createQueryBuilder('BiopenGeoDirectoryBundle:Element');

    // convert kilometre in degrees
    $radius = $distance / 110;
    return $qb->field('status')->gte(-1)->field('coordinates')->withinCenter($lat, $lng, $radius)
              ->select('compactJson')->hydrate(false)->getQuery()->execute()->toArray(); 
  }

  public function findWhithinBoxes($bounds, $optionId, $getFullRepresentation)
  {
    $results = [];

    $qb = $this->createQueryBuilder('BiopenGeoDirectoryBundle:Element');

    //dump("quering getFullRepresentation " . $getFullRepresentation);

    foreach ($bounds as $key => $bound) 
    {
      if (count($bound) == 4)
      {
        $qb = $this->createQueryBuilder('BiopenGeoDirectoryBundle:Element');

        $qb->field('status')->gte(-1);

        if ($optionId && $optionId != "all")
        {
          //$qb->where("function() { return this.optionValues.some(function(optionValue) { return optionValue.optionId == " . $optionId . "; }); }");
          $qb->field('optionValues.optionId')->in(array((float) $optionId));
        }

        // get elements within box
        $qb->field('coordinates')->withinBox((float) $bound[1], (float) $bound[0], (float) $bound[3], (float) $bound[2]);

        // get json representation
        if ($getFullRepresentation == 'true') 
          {
            $qb->select('fullJson'); 
          }
        else
        {
          $qb->select('compactJson');   
        } 

        // execute request   
        $array = $qb->hydrate(false)->getQuery()->execute()->toArray(); 
        $results = array_merge($results, $array);  
      }
    }

    return $results;
  }
}


